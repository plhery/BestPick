<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SigLIP2 Prompt Tester</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #0f172a;
    }

    .score-bar {
      transition: width 0.3s ease;
    }
  </style>
</head>

<body class="min-h-screen text-slate-200 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">
      SigLIP2 Prompt Tester
    </h1>
    <p class="text-slate-400 mb-8">Upload an image and test different prompts to see how well they match.</p>

    <!-- Status -->
    <div id="status" class="mb-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
      <span class="text-yellow-400">Loading model...</span>
    </div>

    <!-- Image Upload -->
    <div class="mb-6">
      <label class="block text-sm font-medium mb-2">Upload Image</label>
      <div class="flex gap-4 items-start">
        <div id="dropzone"
          class="flex-1 border-2 border-dashed border-slate-600 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
          <input type="file" id="imageInput" accept="image/*" class="hidden">
          <p class="text-slate-400">Click or drag an image here</p>
        </div>
        <div id="preview" class="w-48 h-48 bg-slate-800 rounded-xl overflow-hidden hidden">
          <img id="previewImg" class="w-full h-full object-cover">
        </div>
      </div>
    </div>

    <!-- Prompts -->
    <div class="mb-6">
      <label class="block text-sm font-medium mb-2">Test Prompts (one per line)</label>
      <textarea id="prompts" rows="8"
        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-sm font-mono focus:outline-none focus:border-blue-500"
        placeholder="a photo of a person's face
a selfie
a group of people
a landscape photo
a screenshot
food on a plate
a drawing or illustration"></textarea>
    </div>

    <!-- Compare Button -->
    <button id="compareBtn" disabled
      class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 text-white font-medium py-3 px-6 rounded-lg transition-colors mb-8">
      Compare Prompts
    </button>

    <!-- Results -->
    <div id="results" class="space-y-3 hidden">
      <h2 class="text-xl font-semibold mb-4">Results (sorted by similarity)</h2>
      <div id="resultsList"></div>
    </div>
  </div>

  <script type="module">
    import { AutoProcessor, SiglipVisionModel, SiglipTextModel, AutoTokenizer, RawImage } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.5.1';

    const MODEL_ID = 'onnx-community/siglip2-base-patch16-512-ONNX';

    let visionModel = null;
    let textModel = null;
    let processor = null;
    let tokenizer = null;
    let imageEmbedding = null;

    const statusEl = document.getElementById('status');
    const dropzone = document.getElementById('dropzone');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const promptsEl = document.getElementById('prompts');
    const compareBtn = document.getElementById('compareBtn');
    const results = document.getElementById('results');
    const resultsList = document.getElementById('resultsList');

    // Load models
    async function loadModels() {
      try {
        statusEl.innerHTML = '<span class="text-yellow-400">Loading vision model...</span>';

        processor = await AutoProcessor.from_pretrained(MODEL_ID);
        visionModel = await SiglipVisionModel.from_pretrained(MODEL_ID, {
          device: 'webgpu',
          dtype: 'fp16',
        });

        statusEl.innerHTML = '<span class="text-yellow-400">Loading text model...</span>';

        tokenizer = await AutoTokenizer.from_pretrained(MODEL_ID);
        textModel = await SiglipTextModel.from_pretrained(MODEL_ID, {
          device: 'webgpu',
          dtype: 'fp16',
        });

        statusEl.innerHTML = '<span class="text-green-400">Models loaded! Upload an image to start.</span>';
        updateButtonState();
      } catch (error) {
        statusEl.innerHTML = `<span class="text-red-400">Error loading models: ${error.message}</span>`;
        console.error(error);
      }
    }

    // Extract image embedding
    async function extractImageEmbedding(imageUrl) {
      const image = await RawImage.fromURL(imageUrl);
      const inputs = await processor(image);
      console.log('Image inputs:', Object.keys(inputs));

      const outputs = await visionModel(inputs);
      console.log('Image outputs:', Object.keys(outputs));

      // SigLIP uses pooler_output
      const embeds = outputs.pooler_output ?? outputs.image_embeds ?? outputs.last_hidden_state;
      return embeds.normalize ? embeds.normalize(2, -1) : embeds;
    }

    // Extract text embedding
    async function extractTextEmbedding(text) {
      const inputs = tokenizer(text, { padding: 'max_length', truncation: true, max_length: 64 });
      console.log('Text inputs:', Object.keys(inputs));

      const outputs = await textModel(inputs);
      console.log('Text outputs:', Object.keys(outputs));

      // SigLIP uses pooler_output
      const embeds = outputs.pooler_output ?? outputs.text_embeds ?? outputs.last_hidden_state;
      return embeds.normalize ? embeds.normalize(2, -1) : embeds;
    }

    // Cosine similarity
    function cosineSimilarity(a, b) {
      const aData = a.data;
      const bData = b.data;
      let dot = 0;
      for (let i = 0; i < aData.length; i++) {
        dot += aData[i] * bData[i];
      }
      return dot;
    }

    // Handle image upload
    async function handleImageUpload(file) {
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      preview.classList.remove('hidden');

      statusEl.innerHTML = '<span class="text-yellow-400">Extracting image features...</span>';

      try {
        imageEmbedding = await extractImageEmbedding(url);
        statusEl.innerHTML = '<span class="text-green-400">Image processed! Enter prompts and click Compare.</span>';
        updateButtonState();
      } catch (error) {
        statusEl.innerHTML = `<span class="text-red-400">Error processing image: ${error.message}</span>`;
        console.error(error);
      }
    }

    // Compare prompts
    async function comparePrompts() {
      const promptText = promptsEl.value.trim();
      if (!promptText || !imageEmbedding) return;

      const prompts = promptText.split('\n').map(p => p.trim()).filter(p => p.length > 0);
      if (prompts.length === 0) return;

      compareBtn.disabled = true;
      compareBtn.textContent = 'Processing...';
      results.classList.remove('hidden');
      resultsList.innerHTML = '<p class="text-slate-400">Calculating similarities...</p>';

      try {
        const scores = [];

        for (const prompt of prompts) {
          const textEmbed = await extractTextEmbedding(prompt);
          const similarity = cosineSimilarity(imageEmbedding, textEmbed);
          scores.push({ prompt, similarity });
        }

        // Sort by similarity (highest first)
        scores.sort((a, b) => b.similarity - a.similarity);

        // Find min/max for scaling the bars
        const maxSim = Math.max(...scores.map(s => s.similarity));
        const minSim = Math.min(...scores.map(s => s.similarity));
        const range = maxSim - minSim || 1;

        // Render results
        resultsList.innerHTML = scores.map((item, index) => {
          const percentage = ((item.similarity - minSim) / range * 100).toFixed(0);
          const rawScore = (item.similarity * 100).toFixed(2);
          const isTop = index === 0;

          return `
            <div class="p-4 bg-slate-800 rounded-lg border ${isTop ? 'border-green-500/50' : 'border-slate-700'} mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="${isTop ? 'text-green-400 font-medium' : 'text-slate-300'}">${item.prompt}</span>
                <span class="text-sm font-mono ${isTop ? 'text-green-400' : 'text-slate-400'}">${rawScore}</span>
              </div>
              <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="score-bar h-full ${isTop ? 'bg-green-500' : 'bg-blue-500'} rounded-full" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        resultsList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
        console.error(error);
      }

      compareBtn.disabled = false;
      compareBtn.textContent = 'Compare Prompts';
    }

    function updateButtonState() {
      compareBtn.disabled = !visionModel || !textModel || !imageEmbedding;
    }

    // Event listeners
    dropzone.addEventListener('click', () => imageInput.click());
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-blue-500');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-blue-500');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-blue-500');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleImageUpload(file);
      }
    });
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleImageUpload(file);
    });
    compareBtn.addEventListener('click', comparePrompts);

    // Initialize
    loadModels();
  </script>
</body>

</html>